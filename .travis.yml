language: go

services:
  - docker

before_install:
  - curl -L --output mkcert https://github.com/FiloSottile/mkcert/releases/download/v1.3.0/mkcert-v1.3.0-linux-amd64
  - chmod +x mkcert
  - ./mkcert abtercms.test "*.abtercms.test"
  - mv abtercms.test+1* ./docker/nginx/certs/
  - docker-compose pull
  - docker-compose up -d

install:
  - docker-compose exec php make install

script:
  - docker-compose exec php make build

after_success:
  - docker-compose exec php make pre-coverage
  - docker-compose exec php make coverage
  - docker-compose exec php make post-coverage
  - travis_retry docker-compose exec php ./php-coveralls.phar -v --coverage_clover=./tmp/report/clover.xml --json_path=./tmp/coveralls-upload.json
